\chapter{Estado da Arte}
A plataforma \gls{clav} pode ser divididas em 3 eixos principais:

\begin{enumerate}
    \item \textbf{Frontend}
    Responsável pela interação dos utilizadores com plataforma, bem como chamadas à \gls{api}, podendo esta ser de cariz público ou privado, através do acesso a certas funcionalidades da plataforma (por exemplo: listagens de utilizadores, entidades, legislações, etc).
    
    \item \textbf{Backend}
    Desenvolvido em \emph{NodeJS}, este é responsável por satisfazer os serviços requisitados pelo \emph{Frontend}. Inclui toda a lógica da aplicação, como a camada de acesso a dados, leitura e armazenamento de informação.
    
    \item \textbf{API de dados}
    Responsável pela comunicação e gestão de pedidos dos utilizadores da plataforma, sendo que a sua principal função é servir de elo de ligação entre os resultados guardados em base de dados e o \emph{Frontend} disponibilizado aos utilizadores.
\end{enumerate}

Devido à natureza dos dados presentes na plataforma \gls{clav}, foi necessário proceder a uma correta e estruturada implementação de diversos mecanismos de segurança e proteção contra uso indevido de dados.

\cleardoublepage
\section{Encriptação e criptografia}

Em qualquer aplicação no mundo real, é impensável guardar dados sensíveis, como passwords, em formato \emph{plain-text}. Daí surgiu a necessidade de proteger informação sensível através de métodos designados por \emph{hashing}\footnote{Uma função hash é um algoritmo que mapeia dados de comprimento variável para dados de comprimento fixo.}.\\

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/bcrypt/Hashing.png}
    \caption{Representação de uma função de \emph{hash}.\cite{hashFunction}}
\end{figure}

Em geral, o \emph{hashing} é caracterizado como uma operação de sentido único, através da qual se gera um resultado único, impossível de reverter para o texto original.
Embora esta noção esteja correta e seja de facto impossível, através de um texto já processado por uma função de \emph{hash}, reconstruir o texto original em questão, este não é infalível.

\cleardoublepage
\subsection{Vulnerabilidades} \label{vulnerabilidades}

Para exemplificar vulnerabilidades existentes nas funções criptográficas que recorrem apenas ao \emph{hashing} de passwords, vamos recorrer ao algoritmo \textbf{SHA-1}, pertencente à familia de algoritmos \gls{sha}.

O principal problema das funções da família \gls{sha} assenta no facto de que foram desenvolvidas para serem computacionalmente rápidas. A rapidez com que uma função pode calcular \emph{hashes}, tem um impacto imediato e significativo na quão seguro uma password é.

Embora cálculos mais rápidos levem ao desenvolvimento de algoritmos mais eficientes a nível de computação, também abrem portas a ataques \emph{bruteforce}. Atualmente, com o auxilio de \gls{cpu} e \gls{gpu} modernas, é possível calcular milhões, ou até bilhões de \emph{hashes} por segundo.

Outro problema assenta no facto que qualquer função responsável por \emph{hashing}, para o mesmo texto, retorna sempre o mesmo resultado de \emph{hash}, como podemos verificar na tabela \ref{tab:sha1}.

\begin{center}
    \begin{tabular}{ |p{2cm}|p{2cm}|p{8cm}|  }
        \hline
        \multicolumn{3}{|c|}{Resultados do algoritmo SHA-1} \\
        \hline
        Utilizador & Password & \emph{Hashed} password\\
        \hline
        \textcolor{red}{António} & \textcolor{red}{12345} & \textcolor{red}{\textbf{8cb2237d0679ca88db6464eac60da96345513964}}\\
        Alice & sup3rs3gur4 & 0ce594a80be23686fa95527e219ff162291f80f0\\
        Manuel & uncrackabl3 & c4f9036ecefde84b5a8dc4296abbab1a6c53be60\\
        \textcolor{red}{Gustavo} & \textcolor{red}{12345} & \textcolor{red}{\textbf{8cb2237d0679ca88db6464eac60da96345513964}}\\
        Joana & 1a2b3c4d & b01afc2b077956acc69f99e0b7df1cb70cb01331\\
        \hline
    \end{tabular}
\captionof{table}{Aplicação do algoritmo \emph{SHA-1} a um conjunto de passwords.}\label{tab:sha1} 
\end{center}

Como exemplificado na Tabela \ref{tab:sha1}, o utilizador \textbf{António} e \textbf{Gustavo} partilham a mesma password, logo o resultado após o \emph{hashing} da mesma é idêntico. 

Embora passwords idênticas sejam extremamente comuns, o facto do \emph{hash} resultante ser idêntico apresenta um factor de risco muito mais elevado do que as passwords serem idênticas, pois estaria a expor um número exorbitante de utilizadores a uma grave falha de segurança.

Porém, o simples acto de \emph{hashing} de passwords não é uma solução segura. Este rapidamente foi descartado devido a ser extremamente susceptível a ataques baseado em \emph{rainbow tables}, também conhecidos por \emph{ataques de dicionário}.

Este ataque tem como base o facto de algoritmos como o \emph{SHA-1} ser extremamente rápido e eficiente, sendo que em vez de calcular em tempo real \emph{hashes} aleatórios, utilizam valores de hash pré-calculados para toda e qualquer possível combinação de caracteres, utilizando para validação o método \emph{bruteforce}.

Esta vulnerabilidade foi de tão larga escala, que poderia quebrar \emph{99.9\%} de todas as combinações possíveis de 14 caracteres alfanuméricos em 11 minutos (utilizando a \emph{rainbow table} menos extensa, sendo que com tabelas mais extensas esta figura descia consideravelmente).

\cleardoublepage
\subsection{Melhorias no processo de hashing}

De modo a solucionar o problema anterior, é necessário implementar uma função de \emph{hashing} mais lenta, que seja eficaz na proteção de informação e capaz de abrandar, ou evitar possíveis ataques. Também é necessário que esta função seja adaptativa, ou seja, que devido a avanços tecnológicos em hardware esta se possa adaptar para ter um desempenho similar aos níveis atuais.

De modo a solucionar o problema proveniente de ataques \emph{bruteforce} baseados no uso de \emph{rainbow tables}, foi necessário diversificar ainda mais os \emph{hashes} gerados. Para tal foi adicionado um \emph{salt}\cite{sriramya2015providing}, de modo a fazer qualquer password verdadeiramente única.

De acordo com a \gls{owasp}, o \emph{salt} é um valor aleatório de tamanho fixo, considerado criptograficamente forte, que é adicionado ao input de uma dada função de \emph{hash}, independentemente deste do input ser ou não único.

Na tabela \ref{tab:sha1_salt} podemos verificar a importância de utilizar a técnica de \emph{salting} juntamente com o \emph{hashing} de passwords.

\begin{center}
    \begin{tabular}{ |p{1.7cm}|p{2cm}|p{1.5cm}|p{8cm}|  }
        \hline
        \multicolumn{4}{|c|}{Resultados do algoritmo SHA-1 c/ salting} \\
        \hline
        Utilizador & Password & Salt &\emph{Hashed} password + \textbf{salt}\\
        \hline 
        \textcolor{red}{António} & \textcolor{red}{12345} & r8ZGQH & \textbf{c783b62c876b77310818b3b4cc6863ca008f7d10}\\
        Alice & sup3rs3gur4 & yvL9H8 & d68c7166f916b91b66dda685e8eee1af70528933\\
        Manuel & uncrackabl3 & C4uHRv & 87d8e4e7ae79ab2487133a6513e35cb511687d5a\\
        \textcolor{red}{Gustavo} & \textcolor{red}{12345} & jKM2Lh & \textbf{f69e3288fc17c383cab12aa78a725d675610e81a}\\
        Joana & 1a2b3c4d & WNj7Vt & 866038b3d43de9a9b0b49a6ee1ffc6cbf64d3c6d\\
        \hline
    \end{tabular}
\captionof{table}{Aplicação do algoritmo \emph{SHA-1} com auxílio de \emph{salting} a um conjunto de passwords.}\label{tab:sha1_salt} 
\end{center}

Como exemplificado na Tabela \ref{tab:sha1_salt}, embora o utilizador \textbf{António} e \textbf{Gustavo} partilhem a mesma password, o resultado do \emph{hashing} é diferente.

Facilmente chegamos à conclusão que o \emph{salting} é essencial para manter a segurança de informação importante como passwords, pois um conjunto infinito de passwords idênticas nunca terão o mesmo \emph{hash}.

Embora seja teoricamente possível quebrar este tipo de combinação, esta requer poder computacional exponencialmente maior que um simples ataque \emph{rainbow table}, visto que o \emph{salt} é totalmente aleatório, tornando qualquer ataque inviável.

Em suma, o método de autenticação ideal deve implementar ambos estes métodos\cite{contini2015method}, \emph{hashing} e \emph{salting}, sendo que um dos métodos mais comuns e seguros da atualidade, é o \emph{bcrypt}, tornando-a no perfeito candidato para utilização neste projeto.

\cleardoublepage
\section{Autenticação.Gov} \label{infoAuthGov}

O Autenticação.Gov surge da necessidade de identificação unívoca de um utilizador perante sítios na Web. Cabe a esta solução o processo de autenticação e o fornecimento dos atributos do utilizador necessários a que cada entidade possa efectuar a identificação do utilizador.

O Autenticação.Gov, em conjunto com o \gls{cc}, também permite fazer uso da funcionalidade de Federação de Identidades da \gls{iap} para a identificação sectorial de um Cidadão, isto é, a obtenção dos seus identificadores junto das entidades participantes da iniciativa do Cartão de Cidadão. 

É também responsável pela gestão dos vários fornecedores de atributos disponíveis e possui uma estreita ligação com a infraestrutura de chave pública do Cartão de Cidadão (\gls{pki}), com o intuito de manter elevados níveis de segurança e privacidade no processo de autenticação e identificação, utilizando para tal a linguagem \gls{saml}, sendo esta explicada em maior detalhe na secção \ref{saml_section}.

Através do Autenticação.Gov é possível a criação de credenciais comuns a todos os sites da Administração Pública, assegurando que o utilizador se necessita de autenticar apenas uma única vez para executar um ou vários serviços que podem ser iniciados em portais transversais, sendo este o fundamento do \gls{sso}.

Permite também proceder à autenticação de um utilizador com recursos a outros certificados digitais que não o do Cartão de Cidadão, possibilitando e alargando o leque de autenticação disponível para as Entidades que pretendam delegar a autenticação nesta componente.

Em seguida podemos verificar a quantidade de utilizadores únicos e autenticações realizadas com o auxílio da plataforma \emph{Autenticação.Gov}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.9\textwidth]{img/authgov/authgovusage.png}
    \caption{Evolução do número de autenticações realizadas e utilizadores únicos baseados na plataforma \emph{Autenticação.Gov}.\cite{authGovStats}}
\end{figure}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{img/authgov/authAnos.png}
    \caption{Representação do número total de autenticações realizados com a plataforma \emph{Autenticação.Gov}.\cite{authGovStats}}
\end{figure}


Relativamente ao âmbito do projecto \gls{clav} irá ser implementada a autenticação através dos seguintes meios de autenticação:

\begin{itemize}
    \item \textbf{Obrigatório: } Cartão de Cidadão (\gls{cc})
    
    A utilização do Cartão de Cidadão como meio de autenticação representa mais de 50\% de todos as autenticações realizadas na plataforma \emph{Autenticação.Gov}.
    
    \begin{figure}[h]
        \centering
        \includegraphics[width=0.5\textwidth]{img/authgov/authCC.png}
        \caption{Evolução do número de Autenticações realizadas através do Cartão de Cidadão.\cite{authGovStats}}
    \end{figure}
    
    \cleardoublepage
    \item \textbf{Opcional: }\gls{cmd}
    
    Com a crescente adesão a serviços de autenticação baseadas em \emph{smartphones}, a utilização da Chave Móvel Digital tem vindo a ganhar popularidade nos últimos anos, provando ser uma opção complementar, bem como viável, à utilização do Cartão de Cidadão como meio de autenticação primária.
    
    \begin{figure}[h]
        \centering
        \includegraphics[width=0.45\textwidth]{img/authgov/authCMD.png}
        \caption{Evolução do número de Autenticações realizadas através da Chave Móvel Digital.\cite{authGovStats}}
    \end{figure}
\end{itemize}

\cleardoublepage
\subsection{Principais funcionalidades} \label{authGovFuncionalidades}

O Autenticação.Gov é considerado o principal componente para autenticação, a nível nacional e internacional, sendo que as funcionalidades por ele introduzidas permitem a normalização do processo de autenticação e assinatura eletrónica.

Esta autenticação permite às entidades que a requisitam a recolha de informação do utilizado, sendo esta sempre autorizada pelo mesmo.

As principais funcionalidades do Autenticação.Gov são as seguintes:

\begin{enumerate}
    \item Identificação através do Cartão de Cidadão
    
    O Autenticação.Gov tem como objetivo a identificação segura de um Cidadão, sendo esta baseada na credenciação do mesmo durante a emissão do Cartão de Cidadão, aliado à Federação de Identidades da Plataforma de Interoperabilidade da Administração Pública.
    
    \item Disponibilização de informação
    
    A utilização do Cartão de Cidadão em conjunção com o Autenticação.Gov permite a recolha de informação do Cidadão, através de atributos e identificadores, como por exemplo \textit{NIF} e \textit{NomeCompleto}, através da utilização da Plataforma de Interoperabilidade.
    
    \item Single Sign-On (\gls{sso})
    
    Através do \gls{sso} é possível a navegação entre as várias entidades aderentes, com fornecimento dos atributos necessários para autenticação e garantia do nível de segurança proporcionado pelo Autenticação.Gov.
    
    \item Simplificação do processo de autenticação
    
    O processo de autenticação é delegado ao Autenticação.Gov, sendo este responsável por assegurar a validade de certificados, obtenção dos atributos pedidos e a devolução dos mesmos à entidade que os solicitou.
    
    \item Normalização do processo de autenticação
    
    O processo previamente descrito é realizado com auxilio de vários níveis de segurança e qualidade de serviço. Assim sendo, é garantida a utilização da estrutura da chave pública do Cartão de Cidadão, conhecida por \gls{pki}, com recurso a validação através de \gls{ocsp} dos certificados de autenticação fornecidos.
    
    \item Transparência no processo de autenticação
    
    Sendo o cidadão parte ativa na transmissão de atributos à entidade que o solicita, este tem de dar a sua explícita permissão, podendo negar acesso a certos atributos opcionais, ou até proceder ao cancelamento do processo de autenticação corrente.
\end{enumerate}

\cleardoublepage
\subsection{Workflow do Autenticação.Gov}

O workflow do processo de autenticação com o Autenticação.Gov cinge-se a dois possíveis cenários:

\begin{enumerate}
    \item \textbf{Primeira autenticação}
    
    Este ocorre quando o cidadão/utilizador não possui sessão ativa no portal do Autenticação.Gov, quer por a sessão prévia ter expirado ou esta ser inexistente.
    
    \item \textbf{Re-autenticação ou Renovação de uma autenticação prévia}
    
    Quando o cidadão/utilizador já teve sessão iniciada numa entidade utilizadora do Autenticação.Gov, este pode simplesmente confirmar a cedência de dados à plataforma \gls{clav}, não havendo a necessidade de nova introdução de PIN de autenticação, excepto num caso explorado na secção \ref{renovacaoAuth}.
\end{enumerate}

\subsubsection{Primeira autenticação}
De acordo com o manual de Integração do Autenticação.Gov\cite{manualAuthGov} providenciado pela \gls{ama}, existem 4 interacções entre o \emph{Autenticação.Gov} e a entidade/serviço a aceder, especificadas na figura \ref{workflow}.

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/authgov/workflow.png}
    \caption{Workflow de autenticação via Cartão de Cidadão.}
    \label{workflow}
\end{figure}

\begin{enumerate}
    \item O utilizador pretende aceder à área privada do portal de uma entidade, na qual é necessário que comprove a sua identidade (neste caso a plataforma \gls{clav}).
    \item O portal da entidade delega a autenticação e redireciona o utilizador para o Auten-ticação.Gov, juntamente com um pedido de autenticação assinado digitalmente.
    \item O Autenticação.Gov valida o pedido de autenticação recebido e solicita a autenticação do utilizador com recurso ao seu Cartão de Cidadão pedindo a inserção do seu PIN de autenticação. Durante este processo, o Autenticação.Gov efetua as seguintes operações internas:
    \begin{enumerate}
        \item Valida as credenciais do utilizador com recurso à PKI do Cartão de Cidadão via \gls{ocsp}.
        \item Obtém atributos que sejam solicitados pelo portal da entidade junto dos vários fornecedores de atributos qualificados. Esta operação é efetuada via Plataforma de Interoperabilidade. Este processo pode incluir a obtenção de dados da Fe-deração de Identidades ou de outras Entidades.
    \end{enumerate}
    \item A identificação e atributos do utilizador são autenticadas e assinados digitalmente pelo Autenticação.Gov, após o que redirecciona o utilizador de volta ao portal da entidade original. Cabe à entidade a validação das credenciais do Autenticação.Gov e utilização dos atributos do cidadão.
\end{enumerate}

\cleardoublepage
\subsubsection{Renovação de autenticação} \label{renovacaoAuth}

Além das etapas numeradas entre \textbf{1} e \textbf{4} da figura \ref{workflow}, existe a possibilidade de o utilizador já ter sessão iniciada noutro portal da \gls{ap}, como por exemplo, a Segurança Social Direta\footnote{Mais informações em \url{https://app.seg-social.pt/ptss/}}.

A utilização do Autenticação.Gov tem como principal função a simsimplificação do processo de autenticação nos vários portais da \gls{ap}. Ou seja, este permite a autenticação de utilizadores entre diversos sites da \gls{ap} ou entidades privadas, como por exemplo a plataforma \gls{clav}, solicitando as credenciais do mesmo apenas uma vez, sendo estas revalidadas junto do Autenticação.Gov sem necessidade de nova inserção do PIN de autenticação.

Esta capacidade de re-autenticação sem nova inserção do PIN de autenticação é exemplificada na figura \ref{workflow2}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{img/authgov/workflow2.png}
    \caption{Workflow de re-autenticação via Cartão de Cidadão.}
    \label{workflow2}
\end{figure}

\begin{enumerate}
    \setcounter{enumi}{4}
    \item É feito o acesso a uma nova entidade, neste caso a plataforma \gls{clav}, tendo o utilizador feito a autenticação na entidade prévia.
    \item O site da entidade revalida a credencial electrónica junto do Autenticação.Gov.
    \item Cabe ao Autenticação.Gov re-emitir ou revalidar a credencial consoante os seguintes dois casos:
    \begin{enumerate}
        \item Se forem solicitados os mesmos atributos da última autenticação e estes tenham sido obtidos com um nível de confiança igual ou superior, não será necessária nova introdução de PIN.
        \item Caso sejam pedidos atributos diferentes, então o Autenticação.Gov irá requisitar ao utilizador nova inserção de PIN.
    \end{enumerate}
    \item O site de entidade recebe a resposta do Autenticação.Gov e autentica utilizador em questão.
\end{enumerate}

Através desta implementação de renovação de autenticação, é assegurada a correta imple-mentação de um serviço \gls{sso}, referida na secção \ref{infoAuthGov}.

\cleardoublepage
\subsection{Funcionamento do Autenticação.Gov}

De modo a utilizar o Autenticação.Gov é necessária a criação de um pedido baseado em \gls{saml}, assinado digitalmente com um certificado X.509 e encriptado com a nossa chave \gls{rsa} privada, bem como a respectiva cadeia de autenticação.

Existem dois tipos de pedidos \gls{saml} utilizados pelo Autenticação.Gov:

\begin{itemize}
    \item \textbf{SAML Request}
    
    Pedido de autenticação em formato \gls{saml}, enviado ao Autenticação.Gov, no qual é enviada informação sobre a origem, assinaturas, atributos a requisitar, etc.
    
    \item \textbf{SAML Response}
    
    Resposta em formato \gls{saml} ao pedido previamente referido, enviado em binding \emph{HTTP-POST} para o Issuer do pedido de autenticação.
    
    Na resposta são enviados os dados previamente requisitados, bem como resposta de sucesso, insucesso ou cancelamento do pedido de autenticação por parte do utilizador.
\end{itemize}

\begin{figure}[h]
    \centering
    \includegraphics[width=1.1\textwidth]{img/saml/clavflow.png}
    \caption{Funcionamento do Autenticação.Gov na plataforma CLAV.}
    \label{clavflow}
\end{figure}

Consoante a resposta do Autenticação.Gov, o login do utilizador é autorizado ou negado, consoante exemplo na figura \ref{clavflow}.
Este apenas é negado caso o utilizador erre o PIN de autenticação, negue acesso aos dados pedidos, ou não tenha leitor smart-card no seu computador.

\cleardoublepage
\subsubsection{AuthnRequest}

Um pedido de autenticação \emph{(AuthnRequest)} é composto por 3 secções:

\begin{enumerate}
    \item \textbf{Issuer}
    
    Nesta secção é enviada informação sobre quem está a requisitar a autenticação, neste caso a plataforma \gls{clav}, sendo apenas necessário o envio do \emph{URL} onde origina o pedido\cite{manualAuthGov}.
    
    \lstset{
        language=XML,
        backgroundcolor=\color{white},
        basicstyle=\ttfamily,
        columns=fullflexible,
        showstringspaces=false,
        commentstyle=\color{gray}\upshape,
        xleftmargin=-27pt,
        xrightmargin=-27pt,
    }
    \begin{lstlisting}
        <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">
            http://clav-auth.di.uminho.pt
        </Issuer>
    \end{lstlisting}
    
    \vspace{-10mm}
    \item \textbf{Signature}
    
    Nesta secção é realizada a assinatura digital do pedido \gls{saml}, através de métodos de canonização\cite{manualAuthGov} e transformação especificados no manual de integração.
    
    Posteriormente à assinatura, é transmitida informação sobre o algoritmo utilizado para o cálculo do hash, neste caso \emph{SHA-1}, bem como o valor resultante deste processo de hash.
    
    Por fim, é adicionado o certificado X.509 contendo a respectiva cadeia de autenticação fornecido pela \gls{ama}.
    
    \begin{lstlisting}
<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
    <SignedInfo>
        <CanonicalizationMethod Algorithm="http://www.w3.org/2001/xml-exc-c14n"/>
        <SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
        <Reference URI="#_63f47093-6377-4771-a36e-8bc506cf9e64">
            <Transforms>
                <Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
                <Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
            </Transforms>
            <DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
            <DigestValue>
                msbCCbP1sltYLV...oaZ+nNmWwVHqE=
            </DigestValue>
        </Reference>
    </SignedInfo>
    <SignatureValue>
            gB656A8kkR7TujX8/xfAfYJm...2EX3iK7rXxAd5HAbvB6zV1BXvDYLJ6K+ZOBGF
    </SignatureValue>
    <KeyInfo>
        <X509Data>
            <X509Certificate>
                9AnXwiE5zOybPs8CAwEAAaOB...BlrBlEXYrXxFdIA7qATy
            </X509Certificate>
        </X509Data>
    </KeyInfo>
</Signature>
    \end{lstlisting}
    
    \vspace{-10mm}
    \item \textbf{Extensions}
    
    Esta secção contém os atributos que vamos requisitar ao Autenticação.Gov, aquando da autenticação de um utilizador na plataforma \gls{clav}, neste caso o seu \gls{nic} e Nome Completo.
    
    \begin{lstlisting}
<Extensions>
    <fa:RequestedAttributes xmlns:fa="http://autenticacao.cartaodecidadao.pt/atributos">
        <fa:RequestedAttribute 
            Name="http://interop.gov.pt/MDC/Cidadao/NIC" 
            NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri" 
            isRequired="True"/>
        <fa:RequestedAttribute
            Name="http://interop.gov.pt/MDC/Cidadao/NomeCompleto" 
            NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri" 
            isRequired="True"/>
    </fa:RequestedAttributes>
</Extensions>
    \end{lstlisting}
\end{enumerate}

\lstset{
        language=XML,
        backgroundcolor=\color{white},
        basicstyle=\ttfamily,
        columns=fullflexible,
        showstringspaces=false,
        commentstyle=\color{gray}\upshape,
        xleftmargin=-27pt,
        xrightmargin=-27pt,
    }
\begin{lstlisting}
<AuthnRequest 
    xmlns="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    ID="_63f47093-6377-4771-a36e-8bc506cf9e64"
    Version="2.0"
    IssueInstant="2019-08-20T14:51:18.061Z"
    Destination="https://preprod.autenticacao.gov.pt/fa/Default.aspx"
    ProtocolBinding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
    AssertionConsumerServiceURL="https://clav-auth.di.uminho.pt/assertion"
    ProviderName="CLAV" 
    Consent="urn:oasis:names:tc:SAML:2.0:consent:unspecified">
    <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">
        http://clav-auth.di.uminho.pt
    </Issuer>
    <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
        <SignedInfo>
            <CanonicalizationMethod Algorithm="http://www.w3.org/2001/xml-exc-c14n"/>
            <SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
            <Reference URI="#_63f47093-6377-4771-a36e-8bc506cf9e64">
                <Transforms>
                    <Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
                    <Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
                </Transforms>
                <DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
                <DigestValue>
                    msbCCbP1sltYLV...oaZ+nNmWwVHqE=
                </DigestValue>
            </Reference>
        </SignedInfo>
        <SignatureValue>
            gB656A8kkR7TujX8/xfAfYJm...2EX3iK7rXxAd5HAbvB6zV1BXvDYLJ6K+ZOBGF
        </SignatureValue>
        <KeyInfo>
            <X509Data>
                <X509Certificate>
                    9AnXwiE5zOybPs8CAwEAAaOB...BlrBlEXYrXxFdIA7qATy
                </X509Certificate>
            </X509Data>
        </KeyInfo>
    </Signature>
    <Extensions>
        <fa:RequestedAttributes xmlns:fa="http://autenticacao.cartaodecidadao.pt/atributos">
            <fa:RequestedAttribute 
                Name="http://interop.gov.pt/MDC/Cidadao/NIC" 
                NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri" 
                isRequired="True"/>
            <fa:RequestedAttribute
                Name="http://interop.gov.pt/MDC/Cidadao/NomeCompleto" 
                NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri" 
                isRequired="True"/>
        </fa:RequestedAttributes>
    </Extensions>
</AuthnRequest>
\end{lstlisting}

\cleardoublepage
\subsubsection{AuthnResponse}

\cleardoublepage
\subsection{Especificação do Autenticação.Gov}
\subsubsection{Par de chaves públicas/privadas}

O Autenticação.Gov utiliza um mecanismo de autenticação de pedidos baseado em pares de chaves públicas e privadas. Para tal, é necessário gerar um par de chaves baseado no formato \gls{rsa}, do qual resultam duas chaves:
\begin{itemize}
    \item \textbf{Chave privada: }
    Chave de conhecimento privado, ou seja, apenas o criador da chave possui informação sobre a mesma. Esta é composta por dois números primos aleatórios de comprimento substancial.
    
    \item \textbf{Chave pública: }
    Chave de conhecimento público, disponível para qualquer utilizador, não possuindo qualquer tipo de informação sensível. Esta é o resultado da multiplicação dos dois números primeiros da chave privada, sendo quase impossível a obtenção da combinação original.
\end{itemize}

Na autenticação com o Cartão de Cidadão, é enviado um pedido para o Autenticação.Gov, sendo este assinado digitalmente com auxílio da chave privada. 
Como o Autenticação.Gov possui acesso à chave pública, é-lhe possível verificar instantaneamente a validade do pedido em causa, sendo este processado caso seja válido, ou negado caso contrário.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.80\textwidth]{img/cc/OpenPGPSign.jpg}
    \caption{Exemplo da assinatura e leitura através de par de chaves.}
    \label{fig:par_chaves}
\end{figure}

Na figura \ref{fig:par_chaves} podemos verificar que o funcionamento da assinatura digital baseado em pares de chaves segue os seguintes passos:

\begin{enumerate}
    \item É criado um texto/pedido de autenticação/etc.
    \item Esse pedido previamente criado é assinado com a chave privada do remetente.
    \item Após a recepção do mesmo pelo destinatário, é feita a leitura com o auxílio da chave pública do remetente presente no certificado X509 do mesmo.
\end{enumerate}

Segue-se um exemplo de uma chave \gls{rsa} privada, sendo esta de maior comprimento quando comparada com a chave pública, devido a conter dois números primos (como foi referido no início desta secção).

\vspace{5mm}
\textbf{Exemplo de chave RSA privada:}

\begin{verbatim}
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQCqGKukO1De7zhZj6+H0qtjTkVxwTCpvKe4eCZ0FPqri0cb2JZfXJ/DgYSF6vUp
wmJG8wVQZKjeGcjDOL5UlsuusFncCzWBQ7RKNUSesmQRMSGkVb1/3j+skZ6UtW+5u09lHNsj6tQ5
1s1SPrCBkedbNf0Tp0GbMJDyR4e9T04ZZwIDAQABAoGAFijko56+qGyN8M0RVyaRAXz++xTqHBLh
3tx4VgMtrQ+WEgCjhoTwo23KMBAuJGSYnRmoBZM3lMfTKevIkAidPExvYCdm5dYq3XToLkkLv5L2
pIIVOFMDG+KESnAFV7l2c+cnzRMW0+b6f8mR1CJzZuxVLL6Q02fvLi55/mbSYxECQQDeAw6fiIQX
GukBI4eMZZt4nscy2o12KyYner3VpoeE+Np2q+Z3pvAMd/aNzQ/W9WaI+NRfcxUJrmfPwIGm63il
AkEAxCL5HQb2bQr4ByorcMWm/hEP2MZzROV73yF41hPsRC9m66KrheO9HPTJuo3/9s5p+sqGxOlF
L0NDt4SkosjgGwJAFklyR1uZ/wPJjj611cdBcztlPdqoxssQGnh85BzCj/u3WqBpE2vjvyyvyI5k
X6zk7S0ljKtt2jny2+00VsBerQJBAJGC1Mg5Oydo5NwD6BiROrPxGo2bpTbu/fhrT8ebHkTz2epl
U9VQQSQzY1oZMVX8i1m5WUTLPz2yLJIBQVdXqhMCQBGoiuSoSjafUhV7i1cEGpb88h5NBYZzWXGZ
37sJ5QsW+sJyoNde3xH8vdXhzU7eT82D6X/scw9RZz+/6rCJ4p0=
-----END RSA PRIVATE KEY-----
\end{verbatim}

De seguida temos um exemplo de uma chave pública, de menor comprimento quando comparada com a chave privada (devido a ser o produto dos dois números primos da chave privada).

\vspace{5mm}
\textbf{Exemplo de chave RSA pública:}

\begin{verbatim}
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCqGKukO1De7zhZj6+H0qtjTkVxwTCpvKe4eCZ0
FPqri0cb2JZfXJ/DgYSF6vUpwmJG8wVQZKjeGcjDOL5UlsuusFncCzWBQ7RKNUSesmQRMSGkVb1/
3j+skZ6UtW+5u09lHNsj6tQ51s1SPrCBkedbNf0Tp0GbMJDyR4e9T04ZZwIDAQAB
-----END PUBLIC KEY-----
\end{verbatim}

\cleardoublepage
\subsubsection{Certificado X.509}

O Autenticação.Gov requer o fornecimento de um certificado no pedido SAML, de modo a validar as origens do pedido, bem como confirmar a integridade e validade do mesmo.

O formato deste certificado é designado por \emph{X.509}\cite{x509}, um padrão criado pela \gls{itu} em 1988.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{img/x509/formato.png}
    \caption{Formato de um certificado X.509 v3.}
    \label{fig:x509formato}
\end{figure}

Este pode conter várias informações além da chave \gls{rsa} pública (ver figura \ref{fig:x509formato}), sendo que ao abrigo do Autenticação.Gov, os certificados X.509 por ele utilizados contêm a seguinte informação:

\begin{itemize}
    \item Chave pública e respetivo algoritmo.
    \item Nome da Entidade.
    \item Entidade emissora.
    \item Data de emissão.
    \item Validade do certificado.
    \item Informações de contacto.
    \item Assinatura e respetivo algoritmo.
\end{itemize}

Com o auxílio desta informação, é possível verificar e validar o certificado, como tendo sido emitido por uma entidade certificada, sendo este passo crucial para os pedidos de autenticação com o Cartão de Cidadão.

De modo a garantir a validade do certificado, as seguintes regras têm de ser obedecidas:

\begin{enumerate}
    \item O certificado tem de possuir uma entidade emissora válida (neste caso, a plataforma \gls{clav} é a entidade emissora certificada pela \gls{ama}).
    \item O certificado tem de possuir uma data de validade válida e não pode estar expirado.
    \item O certificado não pode estar presente na lista de certificados revogados.
    \item Todos os certificados da sua cadeia de certificação têm de ser válidos.
\end{enumerate}

Um objecto contendo as características previamente descritas pode ser representado através do padrão \emph{X.509}, sendo este utilizado como suporte para a \gls{pki} (Public Key Infrastucture).

A estrutura definida pela \gls{pki} é utilizada de forma universal para a autenticação de utilizadores através de certificados de chave pública.\cite{pki}

A utilização destes certificados, auxiliados pela utilização de um canal de comunicação seguro via \emph{HTTPS} e \emph{SSL} (explorado em detalhe na secção \ref{ssl_section}) garantem a autenticidade e confidencialidade necessárias à utilização de serviços sensíveis, como por exemplo, a autenticação com o auxílio do Cartão de Cidadão.

\vspace{10mm}
\textbf{Exemplo de Certificado X.509:}
\begin{verbatim}
subject=/emailAddress=it@ama.pt/C=PT/L=Lisboa/O=AMA/OU=IT/CN=Autenticacao.Gov
issuer=/emailAddress=it@ama.pt/C=PT/L=Lisboa/O=AMA/OU=IT/CN=Autenticacao.Gov
-----BEGIN CERTIFICATE-----
MIIDzDCCArSgAwIBAgIGAWHCrFAKMA0GCSqGSIb3DQEBCwUAMHMxGDAWBgkqhkiG
9w0BCQETCWl0QGFtYS5wdDELMAkGA1UEBhMCUFQxDzANBgNVBAcTBkxpc2JvYTEM
MAoGA1UEChMDQU1BMQswCQYDVQQLEwJJVDEeMBwGA1UEAxMVQXV0ZW50aWNhY2Fv
LkdvdiBSYWl6MB4XDTE4MDIwNjEyMzg0OFoXDTI5MDIwNTEyMzg0OFowczEYMBYG
CSqGSIb3DQEJARMJaXRAYW1hLnB0MQswCQYDVQQGEwJQVDEPMA0GA1UEBxMGTGlz
Ym9hMQwwCgYDVQQKEwNBTUExCzAJBgNVBAsTAklUMR4wHAYDVQQDExVBdXRlbnRp
Y2FjYW8uR292IFjBkMB8GA1UdIwQYMBaAFLLBjPTQe0ItzZ3Cda8123axE-23971
iHk+GwTe8PDpMB0GA1UdDgQWBBSywYz00HtCLc2dwoh5PhsE3vDw6TASBgNVHRMB
Af8ECDAGAQH/AgEBMA4GA1UdDwEB/wQEAwICBDANBgkqhkiG9w0BAQsFAAOCAQEA
PIRDKpYrNQRd2/5/+Pm/xN1KXbk3uZUNPsL0T2Hz/RJoX7X3gg0+d1i9cem3izNP
hQXuh5GO4z+hTIBDfnpvPnjVbYZTZaApkO/GmdC6VpXBVfR4H8A7z1CzOQ52F81n
WHYfgpUXQfyCz1KPNw7ba4LYdiTaAg8Yyd6BmGb0ud5Pq235AzpbvJs9I7HniGMD
eVLH6asnt4RUkaJrIelrqSHC1ZJNXHA75LlQHkaaxG8mWnRmb4ikmaR923hca6oQ
1JyGrOvrVLTVKdNgy1wKSyA47HZzHLMto5EBxj/j5xKJ040MNN2N1Isg+kBEqkt+
pAR+Z3kctgfUVHton0cwJQ==
-----END CERTIFICATE-----
\end{verbatim}

\cleardoublepage
\subsubsection{SAML 2.0} \label{saml_section}

O \gls{saml} define um padrão standard para a troca de informação segura entre diversas entidades na Web.

Mais precisamente, o \gls{saml} define um framework \gls{xml} para a troca de asserções de informação entre entidades. 

\begin{displayquote}
"...to define, enhance, and maintain a standard XML-based framework for creating and 
exchanging authentication and authorization information."
\\[5pt]
\rightline{{-- Security Assertion Markup Language V2.0 Technical Overview\cite{hughes2005security}}}
\end{displayquote}

A versão 2.0 do \gls{saml} foi aprovada pela \gls{oasis} em 2005, modificando o standard de tal forma, que implementações baseadas na versão prévia (versão 1.1) eram incompatíveis com o novo standard.

Na especificação técnica do \gls{saml} existem dois \emph{providers}:

\begin{itemize}
    \item \emph{Identity provider}: faculta a autenticação, verificando a identidade do utilizador, procedendo ao envio de informação para o \emph{Service provider}, juntamente com os níveis de acesso do utilizador (Autenticação.Gov).
    \item \emph{Service provider}: requisita a autenticação ao \emph{Identity provider} de modo a proceder à autorização do utilizador (Plataforma \gls{clav}).
\end{itemize}

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/saml/samlproviders.jpg}
    \caption{Interação entre o utilizador e os respetivos \emph{Providers}. \cite{samlProviderPic}}
\end{figure}

Devido à especificação do \gls{saml}, este permite a utilização de \gls{sso}, ou seja, após um único login do utilizador, essas mesmas credenciais podem ser reutilizadas para proceder ao \emph{login} noutros \emph{Service Providers}.

De modo a realizar comunicação entre os \emph{providers} é utilizado um documento \gls{xml}, conhecido por \emph{SAML Assertion}. Existem 3 tipos de \emph{Assertions}:

\begin{enumerate}
    \item \emph{Authentication}: forcene identificação do utilizador em questão, providenciando dados como a hora a que o login foi realizado e que tipo de autenticação foi utilizada (por exemplo: Cartão de Cidadão).
    \item \emph{Attribution}: transmite atributos \gls{saml} (um atributo \gls{saml} trata-se de um formato de dados responsável pela transmição de informação sobre o utilizador) para o \emph{Service Provider}.
    \item \emph{Authorization}: reporta se o utilizador está autorizado a utilizar o serviço em questão, ou se este foi negado autorização pelo \emph{Identity Provider}.
\end{enumerate}

Em suma, o \gls{saml} funciona através do partilha de informação sobre utilizadores, login e atributos entre ambos os \emph{Providers}. 

Após ser realizado um login com o auxílio do \emph{Identity Provider}, este pode enviar atributos SAML para o \emph{Service Provider} quando o utilizador tenta aceder a certos serviços. Por ventura, o \emph{Service Provider} requesita autorização e autenticação ao \emph{Identity Provider}.

\newpage
\subsubsection{SSL} \label{ssl_section}

\newpage
\section{Cartão de Cidadão}

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/cc/CartaoCidadao.png}
    \caption{Exemplo de um Cartão de Cidadão\cite{ccPic}.}
\end{figure}

\subsection{Funcionamento do Cartão de Cidadão}

\subsection{Especificação do Cartão de Cidadão}

\cleardoublepage
\section{API de dados}

No âmbito do projeto \gls{clav} é disponibilizada uma \gls{api} pública de modo a serem feitas \emph{queries} à base de dados.

De modo a estas chamadas, bem como controlar uso indevido da mesmas, foi necessário implementar autenticação e controlo através de \gls{jwt}\footnote{Mais informação em \url{https://jwt.io}}.

A essência do \gls{jwt} assenta no facto do token ser ou não válido, ou seja, se este já expirou ou foi revogado. A implementação deste token foi feita de forma a ser possível monitorizar quem está a fazer chamadas à \gls{api}, podendo a qualquer altura revogar autorização para tal, bem como a auto-revogação após 30 dias.

Estes cuidados ajudam a evitar problemas, tais como ataques à \gls{api} através de sucessivas chamadas num curto espaço de tempo, o que provoca uma sobrecarga no sistema.

\subsection{Introdução ao JSON Web Token}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/jwt/jwtlogo.png}
    \caption{Logótipo do \emph{JSON Web Token}. \cite{jwtLogo}}
\end{figure}

Mas o que define um \gls{jwt}? Um \gls{jwt} é nada mais que um \emph{standard RFC 7519}\cite{jones2015json}\cite{peyrott2016jwt}\footnote{Mais informação em \url{https://tools.ietf.org/html/rfc7519}} desenvolvido para a troca de pedidos em ambientes cujo espaço é limitado. 

Atualmente, este é utilizado nos frameworks web mais populares, devido ao seu tamanho compacto, simplicidade e usabilidade, tornando-o no perfeito candidato para diversas aplicações.

\cleardoublepage
\subsection{Funcionamento do JSON Web Token}

Um \emph{JSON Web token} é composto por 3 elementos distintos (quebras de linha inseridas para melhorar a leitura), separados por um ponto (\textbf{ . }) entre cada elemento:

\begin{center}
    \textbf{\textcolor{red}{eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9}.\\
    \textcolor{green}{eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Ik\\9jdMOhdmlvIE1haWEiLCJudW1BbHVubyI6NzEzNjl9}.\\
    \textcolor{blue}{SneQiuAGUW9aTpxlNNbMkEoYNj7v4-Sw\_5jl134-hosk}}
\end{center}

Embora seja impossível retirar alguma informação útil do \emph{token} exemplificado anteriormente, este contem informação extremamente útil, tendo sido gerado através da seguinte informação:

\begin{itemize}
    \item Header (representado a vermelho).
    \begin{verbatim}
    {
      "alg": "HS256",
      "typ": "JWT"
    }
    \end{verbatim}
    
    Todos os \emph{JSON Web Token} possuem um header. Este elemento estabelece qual o algoritmo utilizado, se o \gls{jwt} foi assinado ou encriptado e por norma, como proceder ao parse do resto do \gls{jwt}.
    
    O único atributo obrigatório num \gls{jwt} é o \emph{alg}, sendo que em \gls{jwt} que não foram encriptados este valor é \textbf{none}, sendo que neste exemplo foi utilizada a encriptação \textbf{HS256}, ou seja, \gls{hmac} com o auxílio de \emph{SHA-256}.
    
    Existem tambem atributos opcionais, tais como \emph{typ}, cuja função é distinguir entre o \gls{jwt} e outros tipos de dados que possam ser transmitidos no mesmo formato\footnote{Tipos de dados transmissíveis: \url{http://www.iana.org/assignments/media-types/media-types.xhtml}}, sendo que neste exemplo é transmitido um \emph{JWT} e \emph{cty}, que apenas é utilizado quando existem aninhamento de \gls{jwt} dentro de outro(s) \gls{jwt}.
    
    Após o uso do algoritmo \textbf{HS256}, a informação acima representada é transcrita sobre a forma da seguinte string:
    
    \begin{center}
        \textbf{\emph{eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9}}
    \end{center}
    
    \newpage
    \item Payload (representado a verde).
    \begin{verbatim}
    {
      "sub": "1234567890",
      "name": "Octavio Maia",
      "numAluno": 71369
    }
    \end{verbatim}
    
    O payload é o elemento responsável pelo armazenamento de todo e qualquer dado do utilizador. Como o header, este elemento segue o formato \emph{JSON}, embora que todos os atributos presentes no payload sejam de natureza opcional, ao contrário do header que possui pelo menos um atributo de cariz obrigatório.
    
    De acordo com a especificação do payload, existem 7 atributos registados, sendo que neste exemplo apenas existe um, designado por \emph{sub}. Este atributo contem informação sobre quem se trata a informação contida neste \gls{jwt}, sendo que para tal efeito, este atributo é de cariz único na aplicação em questão.
    
    Os atributos designados por \emph{name} e \emph{numAluno} são designado por atributos não registados, podendo conter qualquer tipo de informação representável sobre a forma de string.
    
    No âmbito do projeto \gls{clav} são utilizados outros atributos registados, sendo o de maior importância o atributo \emph{exp}, cuja função é representar uma data específica, seguindo o formato \emph{"seconds since epoch"}\footnote{Definido pela \gls{posix} em \url{http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html##tag_04_15}}, após a qual o \gls{jwt} é considerado inválido.
    
    A informação acima representada anteriormente é transcrita sobre a forma da seguinte string:
    
    \begin{center}
        \textbf{\emph{eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Ik\\9jdMOhdmlvIE1haWEiLCJudW1BbHVubyI6NzEzNjl9}}
    \end{center}
    
    \newpage
    \item Assinatura (representado a azul).
    \begin{verbatim}
    HMACSHA256(
      base64UrlEncode(header) + "." +
      base64UrlEncode(payload),
      secretKey  
    )
    \end{verbatim}
    
    Embora a definição de \gls{jwt} apenas abranja os dois elementos previamente estudados, o terceiro elemento apenas tem como função a desencriptação do \gls{jwt} para efeitos de \emph{parsing}.
    
    Por norma é utilizado uma variante do algoritmo \emph{Base64}, designada por \emph{Base64-URL}. Para encriptar a assinatura, são concatenadas 3 strings que foram sujeitas ao codificação via \emph{Base64-URL}.
    
    \begin{verbatim}
        [Base64-URL header].[Base64-URL payload].[secretKey]
    \end{verbatim}
    
    O resultado desta concatenação e posterior encriptação via \textbf{HS256} é a seguinte string:
    
    \begin{center}
        \textbf{\emph{SneQiuAGUW9aTpxlNNbMkEoYNj7v4-Sw\_5jl134-hosk}}
    \end{center}
\end{itemize}

\cleardoublepage
\subsection{Vulnerabilidades do JSON Web Token}